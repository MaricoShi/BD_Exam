@{
    ViewBag.Title = "单位档案室";
    Layout = null;
}

@*<div class="seekask-title">
    <h4>单位档案室</h4>
</div>*@

@Scripts.Render(Url.Content("~/Scripts/bootstrap-treeview.js"))
@Styles.Render(Url.Content("~/Content/bootstrap-treeview.min.css"))
<style type="text/css">
    #orgList_Menu {
        position:absolute;
        width:10rem;
        z-index:20;
    }
    #orgList_Menu>li{cursor:pointer;}
</style>

<div id="orgList" class="col-sm-4"></div>

<div class="modal fade madal-addorg">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">机构维护</h4>
            </div>
            <div class="modal-body">

                <div class="row">
                    <div class="col-lg-6">
                        <div class="input-group">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button">机构代码</button>
                            </span>
                            <input type="text" class="form-control" data-title="机构代码" id="txtOrgCode" placeholder="请输入机构代码">
                        </div><!-- /input-group -->
                    </div><!-- /.col-lg-6 -->

                    <div class="col-lg-6">
                        <div class="input-group">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button">机构全称</button>
                            </span>
                            <input type="text" class="form-control" data-title="机构全称" id="txtOrgName" placeholder="请输入机构全称">
                        </div><!-- /input-group -->
                    </div><!-- /.col-lg-6 -->


                </div><!-- /.row -->
                <br/>
                <div class="row">

                    <div class="col-lg-6">
                        <div class="input-group">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button">机构简称</button>
                            </span>
                            <input type="text" class="form-control" data-title="机构简称" id="txtShortName" placeholder="请输入机构简称">
                        </div><!-- /input-group -->
                    </div><!-- /.col-lg-6 -->

                    <div class="col-lg-6">
                        <div class="input-group">
                            <span class="input-group-btn">
                                <button class="btn btn-default" type="button">排序号码</button>
                            </span>
                            <input type="text" class="form-control" id="txtSortCode" placeholder="请输入排序号码(整数)">
                        </div><!-- /input-group -->
                    </div><!-- /.col-lg-6 -->
                </div><!-- /.row -->
                
            </div>
            <div class="modal-footer">
                <p class="errmsg pull-left text-danger"></p>
                <button type="button" class="btn btn-primary" id="btnOrgSave">保存</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript">
    var TreeNodes,
        oprateType,
        _ParentCode;


    function getTree(Pcode) {
        var _option = {
            url: "@Url.Content("~/BaseManager/getOrgDataList")?ParentCode=" + (Pcode || "")
        },
        tree = [];
        $.web.get(_option, {
            OnSuccess: function (xhrData) {
                if (xhrData) {
                    $.each(xhrData, function(_i,_t) {
                        tree.push(
                            {
                                text: _t.OrgName,
                                state: {
                                    orgcode: _t.OrgCode
                                },
                                nodes:_t.HasChildren?[]:null
                            }
                            );
                    });
                }
            },
            onFailure: function(err) {
                console.log(err);
            }
            
        });
        return tree;
    }

    //右键菜单
    function RightMouseMenu(_X, _Y) {
        var _top = $("#orgList").offset().top,
            _left = $("#orgList").offset().left;
            _X -= _left;
            _Y -= _top;
        
        $("#orgList").before(
            $("<ul>", { "class": "list-group", "id": "orgList_Menu"})
            .append(
            $("<li>", { "class": "list-group-item" }).text("新增子节点").click(function() {
                //console.log("你点击了新增子节点");
                //antd.message.info('你点击了新增子节点');
                oprateType = "add";
                $(".errmsg").empty();
                $("#txtSortCode").val("999")
                $(".madal-addorg").modal("show");
                $(this).parent().remove();
            })
            )
            .append(
            $("<li>", { "class": "list-group-item" }).text("修改").click(function () {
                oprateType = "modify";
                $(".errmsg").empty();
                $(".madal-addorg").modal("show");
                $(this).parent().remove();
            })
            )
            .append(
            $("<li>", { "class": "list-group-item" }).text("删除").click(function () {
                console.log("你点击了删除");
                antd.message.info('你点击了删除');
                $(this).parent().remove();
            })
            )
            .css({ "left": _X, "top": _Y })
            );
    }

    function getNode(nId) {
        return $('#orgList').treeview('getNode', nId);
    }

    function addNode(nId,option) {
        $("#orgList").treeview("addNode", [nId,option ]);
    }

    function SaveData() {
        $.web.postWithOption({
            url:"@Url.Content("~/BaseManager/OrgOperate")",
            data:{
                "type":oprateType,
                "data": {
                    "OrgCode": $("#txtOrgCode").val(),
                    "OrgName": $("#txtOrgName").val(),
                    "SortCode": $("#txtSortCode").val(),
                    "ShortName": $("#txtShortName").val(),
                    "ParentCode": _ParentCode
                }
            }
        }, {
            OnSuccess: function (xhr)
            {

            },
            OnComplete: function() {
                debugger;
            }
        });
    }

    $(function () {

        //$(document).bind("contextmenu", function () { console.log("右键菜单");  return false; });

        $("#orgList").mousedown(function (e) {
                $("#orgList_Menu").remove();
            //switch (e.which) {
            //    case 1://左键
            //        console.log('这 是左键单击事件');
            //        RightMouseMenu(e.clientX, e.clientY);
            //        break;
            //    case 3://右键键
            //        e.preventDefault();
            //        console.log('这 是右键单击事件x:' + e.clientX + ',y:' + e.clientY);
            //        RightMouseMenu(e.clientX, e.clientY);
            //        break;
            //    default:

            //}
            })
            .treeview({ data: getTree() })
            .on("nodeSelected", function (e, d) {
                var $selectedNode = $("#orgList>ul>li[data-nodeid='" + d.nodeId + "']"),
                    _X = $selectedNode.offset().left + $selectedNode.width()+50,
                    _Y = $selectedNode.offset().top;
                _ParentCode=d.state.orgcode
                RightMouseMenu(_X, _Y);
            })
            .on("nodeExpanded", function (e, node) {
                if (!node.state.IsLoaded) {
                    var $node = getNode(node.nodeId);
                    $node.state["IsLoaded"] = !0;
                    console.log("加载数据");
                    var treeData = getTree($node.state.orgcode);
                    $.each(treeData, function (_i, _t) {
                        addNode(node.nodeId, { "node": _t });
                    });
                    $node.nodes =treeData.length==0?null:treeData;
                }
                else {
                    console.log("已经加载过数据");
                }
            });

        $("#btnOrgSave").click(function () {
            var _err = [];
            for (var i = 0, _l = $("[data-title]").length; i < _l; i++) {
                var $this = $("[data-title]").eq(i);
                if (!$this.val()) { _err.push($this.attr("data-title") + "不可为空"); }
            }
            if ($("#txtSortCode").val()) {
                if (!$.isNumeric($("#txtSortCode").val())) {
                    _err.push("排序号码应为整数");
                }
            }
            else {
                _err.push("排序号码不可为空");
            }
                
            if (_err.length > 0) {
                $(".errmsg").text("警告："+_err.join(";"));
                return;
            }
            SaveData();
        });
    });
</script>